<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Form Requests</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="/styles/normalize.css">
	<link rel="stylesheet" href="/styles/style.css?v=1.0">
	<link rel="stylesheet" href="/styles/backoffice.css?v=1.0">
	<style>
		table {
			width: 100%;
			margin-top: 20px;
		}

		th,
		td {
			padding: 10px;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
		}

		.table-container {
			padding: 20px;
		}

		.arrow {
			cursor: pointer;
		}

		.hidden-row {
			display: none;
		}

		.modal-open .modal {
			overflow-x: hidden;
			overflow-y: auto;
		}

		.profile-image {
			width: 70px;
			height: 70px;
			object-fit: cover;
			border: 1px solid #ddd;
		}

		.modal-body .form-control {
			z-index: 1050;
		}
	</style>
</head>

<body>
	<div class="backoffice-container">
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="/img/logo.png" alt="education logo">
            </div>
            <a href="/profile">Home</a>
            <!-- Admin-specific buttons -->
            <a sec:authorize="hasRole('ADMIN')" href="http://localhost:8080/admin/listUsers">List Users</a>
            <a sec:authorize="hasRole('ADMIN')" href="http://localhost:8080/admin/register">Register</a>

            <!-- Buttons for every user -->
            <a href="/yourTasks">Your tasks</a>
            <a href="/changePassword">Change password</a>
            <a href="/request">View all requests</a>
            <a href="/profileImage">Profile image</a>

            <!-- Logout link -->
            <a id="logoutBtn" th:href="@{/logout}">Logout</a>

        </div>
		<div class="backoffice-content">
			<div class="container">
				<h2 class="mt-4">Form Requests</h2>

				<!-- Exit page button -->
				<a href="/profile" class="btn btn-secondary">Back</a>

				<!-- Table for the requests -->
				<div class="table-container">

					<!-- Loop through GeneralForms -->
					<div th:each="generalForm : ${generalForms}" class="card mb-3">
						<div class="card-header">
							<div class="d-flex justify-content-between align-items-center">
								<div>
									<strong th:text="${generalForm.name ?: 'N/A'}"></strong>
									<span th:text="${generalForm.surname ?: 'N/A'}"></span> |
									<span th:text="${generalForm.email ?: 'N/A'}"></span>
								</div>

								<!-- Arrow to expand/collapse -->
								<button class="btn btn-link" type="button" data-toggle="collapse"
									th:data-target="'#details-' + ${generalForm.id}">
									➤
								</button>
							</div>
						</div>

						<!-- Collapsible content for InformationForms -->
						<div th:id="'details-' + ${generalForm.id}" class="collapse">
							<div class="card-body">
								<table class="table">
									<thead>
										<tr>
											<th>Category</th>
											<th>Content</th>
											<th>Date</th>
											<th>Status</th>
											<th>Employee</th>
											<th sec:authorize="hasRole('ADMIN')">Action</th>
										</tr>
									</thead>
									<tbody>

										<!-- Loop through InformationForms -->
										<tr th:each="informationForm : ${generalForm.informationForms}">
											<td th:text="${generalForm.category.name ?: 'No category'}"></td>
											<!-- Display Category -->
											<td th:text="${informationForm.getContent() ?: 'No content'}"></td>
											<td th:text="${generalForm.submissionDate ?: 'No date'}"></td>
											<td th:text="${informationForm.getStatus() ?: 'TO DO'}"></td>
											<td>
												<div class="d-flex align-items-center">

													<!-- Check if assigned user exists -->
													<div th:if="${informationForm.getAssignedUser() != null}">
														<!-- User image -->
														<img th:src="${informationForm.getAssignedUser().getUserImage() != null ? informationForm.getAssignedUser().getUserImage().imgPath : '/default-user-image.png'}"
															class="profile-image"
															th:alt="'Image of ' + ${informationForm.getAssignedUser().name + ' ' + informationForm.getAssignedUser().surname}"
															data-toggle="tooltip"
															th:title="${informationForm.getAssignedUser().name + ' ' + informationForm.getAssignedUser().surname}" />
													</div>
													<div th:if="${informationForm.getAssignedUser() == null}">
														<span>No employee assigned</span>
													</div>
												</div>
											</td>
											<td>

												<!-- Button to open the assignment modal for user-->
												<button sec:authorize="hasRole('ADMIN')" class="btn btn-primary btn-sm"
													type="button" data-toggle="modal"
													th:data-target="'#assignUserModal-' + ${informationForm.id}">
													Assign User
												</button>

												<!-- Form to remove the currently assigned user from the InformationForm -->
												<form th:action="@{/removeUserFromInformationForm}" method="post"
													th:if="${informationForm.getAssignedUser() != null}"
													sec:authorize="hasRole('ADMIN')"
													onsubmit="return confirm('Are you sure you want to remove this user from the information form?');">
													<input type="hidden" name="informationFormId"
														th:value="${informationForm.id}" />
													<input type="hidden" name="userId"
														th:value="${informationForm.getAssignedUser().id}" />
													<button type="submit" class="btn btn-danger btn-sm">Remove
														User</button>
												</form>

												<!-- Button to open the assignment modal for status-->
												<button sec:authorize="hasRole('ADMIN')" class="btn btn-primary btn-sm"
													type="button" data-toggle="modal"
													th:data-target="'#assignStatusModal-' + ${informationForm.id}">
													Assign Status
												</button>

												<!-- Modal for user assignment -->
												<div th:id="'assignUserModal-' + ${informationForm.id}"
													class="modal fade" tabindex="-1" role="dialog"
													aria-labelledby="assignUserModalLabel" aria-hidden="true">
													<div class="modal-dialog" role="document">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title">Assign User</h5>
																<button type="button" class="close" data-dismiss="modal"
																	aria-label="Close">
																	<span aria-hidden="true">&times;</span>
																</button>
															</div>
															<div class="modal-body">
																<form action="/assignUser" method="post">
																	<input type="hidden" th:name="informationFormId"
																		th:value="${informationForm.id}">

																	<!-- User dropdown list -->
																	<div class="form-group">
																		<label for="userSelect">Select a User</label>
																		<select class="form-control" id="userSelect"
																			name="userId" required>
																			<option value="" disabled selected>Select a
																				user</option>
																			<option th:each="user : ${users}"
																				th:value="${user.id}"
																				th:text="${user.name + ' ' + user.surname}">
																			</option>
																		</select>
																	</div>
																	<button type="submit"
																		class="btn btn-success">Assign</button>
																</form>
															</div>
														</div>
													</div>
												</div>

												<!-- Modal for status assignment -->
												<div th:id="'assignStatusModal-' + ${informationForm.id}"
													class="modal fade" tabindex="-1" role="dialog"
													aria-labelledby="assignStatusModalLabel" aria-hidden="true">
													<div class="modal-dialog" role="document">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title">Assign Status</h5>
																<button type="button" class="close" data-dismiss="modal"
																	aria-label="Close">
																	<span aria-hidden="true">&times;</span>
																</button>
															</div>
															<div class="modal-body">
																<form action="/assignStatus" method="post">
																	<input type="hidden" th:name="informationFormId"
																		th:value="${informationForm.id}">

																	<!-- Status dropdown list -->
																	<div class="form-group">
																		<label for="statusSelect">Select a
																			status</label>
																		<select class="form-control" id="statusSelect"
																			name="informationFormStatus" required>
																			<option value="" disabled selected>Select a
																				status</option>
																			<option value="TO DO">To do</option>
																			<option value="IN PROGRESS">In progress
																			</option>
																			<option value="DONE">Done</option>
																		</select>
																	</div>
																	<button type="submit"
																		class="btn btn-success">Assign</button>
																</form>
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Check if there's a message -->
			<div th:if="${message != null}">
				<p th:text="${message}"></p>
			</div>

			<div th:if="${generalForms != null and generalForms.size() > 0}">
				<!-- Pagination Controls -->
				<div class="pagination">
					<!-- First Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage > 1}"
						th:href="@{/request(page=1)}">First</a>

					<!-- Previous Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage > 1}"
						th:href="@{/request(page=${currentPage - 1})}">Previous</a>

					<!-- Page Numbers -->
					<span th:each="i : ${#numbers.sequence(1, totalPages)}">
						<a class="btn btn-sm" th:href="@{/request(page=${i})}"
							th:classappend="${i == currentPage ? 'btn-primary text-white' : 'btn-light'}"
							th:text="${i}"></a>
					</span>

					<!-- Next Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage < totalPages}"
						th:href="@{/request(page=${currentPage + 1})}">Next</a>

					<!-- Last Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage < totalPages}"
						th:href="@{/request(page=${totalPages})}">Last</a>
				</div>
			</div>
		</div>
	</div>


	<!-- Script to toggle arrow direction -->
	<script>
		$(document).ready(function () {
			$(".arrow").click(function () {
				$(this).text($(this).text() === '➤' ? '▼' : '➤');
			});
		});
		$(document).ready(function () {
			$('[data-toggle="tooltip"]').tooltip();
		});
	</script>
</body>

</html>