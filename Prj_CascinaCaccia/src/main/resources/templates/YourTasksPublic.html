<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>Your tasks public</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="/styles/normalize.css">
	<link rel="stylesheet" href="/styles/style.css?v=1.0">
	<link rel="stylesheet" href="/styles/backoffice.css?v=1.0">
	<style>
		table {
			width: 100%;
			margin-top: 20px;
		}

		th,
		td {
			padding: 10px;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
		}

		.table-container {
			padding: 20px;
		}

		.arrow {
			cursor: pointer;
		}

		.hidden-row {
			display: none;
		}

		.modal-open .modal {
			overflow-x: hidden;
			overflow-y: auto;
		}

		.profile-image {
			width: 70px;
			height: 70px;
			object-fit: cover;
			border: 1px solid #ddd;
		}

		.modal-body .form-control {
			z-index: 1050;
		}
	</style>
</head>

<body>
	<div class="backoffice-container">
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="/img/logo.png" alt="education logo">
            </div>
            <a href="/profile">Home</a>
            <!-- Admin-specific buttons -->
            <a sec:authorize="hasRole('ADMIN')" href="http://localhost:8080/admin/listUsers">List Users</a>
            <a sec:authorize="hasRole('ADMIN')" href="http://localhost:8080/admin/register">Register</a>

            <!-- Buttons for every user -->
            <a href="/yourTasks">Your tasks</a>
            <a href="/changePassword">Change password</a>
            <a href="/request">View all requests</a>
            <a href="/profileImage">Profile image</a>

            <!-- Logout link -->
            <a id="logoutBtn" th:href="@{/logout}">Logout</a>

        </div>
		<div class="backoffice-content">
			<!-- Display assigned forms for the user -->

			<!-- Table for the requests -->
			<div class="table-container">
				<h3>Assigned Forms:</h3>

				<!-- Exit page button -->
				<a href="/admin/listUsers" class="btn btn-secondary">Back</a>
				
				<!-- Category Filter Form -->
				<div class="d-flex justify-content-between align-items-center mb-3">
				    <form method="get" th:action="@{/admin/yourTasksPublic/{userId}(userId=${user.id})}" class="form-inline">
				        <input type="hidden" name="page" th:value="1" />
				        <input type="hidden" name="size" th:value="${size}" />
				        
				        <!-- Category Checkbox Filters -->
		                <div class="form-group mr-2">
		                    <label for="categories">Categories:</label><br />
		                    <div th:each="category : ${categories}">
		                        <input type="checkbox" name="categories" th:value="${category.id}" th:checked="${selectedCategories != null and selectedCategories.contains(category.id)}" />
		                        <span th:text="${category.name}"></span><br />
		                    </div>
		                </div>
		                
		                <!-- Status Checkbox Filters -->
				        <div class="form-group mr-2">
				            <label for="statuses">Status:</label><br />
				            <div>
				                <input type="checkbox" name="statuses" value="TO DO" th:checked="${statusesSelected != null and statusesSelected.contains('TO DO')}" /> TO DO<br />
				                <input type="checkbox" name="statuses" value="IN PROGRESS" th:checked="${statusesSelected != null and statusesSelected.contains('IN PROGRESS')}" /> IN PROGRESS<br />
				                <input type="checkbox" name="statuses" value="DONE" th:checked="${statusesSelected != null and statusesSelected.contains('DONE')}" /> DONE<br />
				            </div>
				        </div>
				        
				        <!-- Sorting Dropdown -->
				        <select class="form-control mr-2" name="sortBy">
				            <option value="newest" th:selected="${sortBy == 'newest'}">Date: Newest to Oldest</option>
				            <option value="oldest" th:selected="${sortBy == 'oldest'}">Date: Oldest to Newest</option>
				            <option value="surnameAsc" th:selected="${sortBy == 'surnameAsc'}">Surname: A to Z</option>
				            <option value="surnameDesc" th:selected="${sortBy == 'surnameDesc'}">Surname: Z to A</option>
				        </select>
				        
				        <!-- Form Type Filter (Information Form or Booking Form) -->
					    <div class="form-group mr-2">
					        <label for="formType">Form Type:</label>
					        <select class="form-control" name="formType">
					            <option value="all" th:selected="${formType == 'all'}">All</option>
					            <option value="informationForm" th:selected="${formType == 'informationForm'}">Information Form</option>
					            <option value="bookingForm" th:selected="${formType == 'bookingForm'}">Booking Form</option>
					        </select>
					    </div>
					    
				        <button type="submit" class="btn btn-primary">Apply</button>
				        
				        <a th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id})}" class="btn btn-secondary ml-2">Reset</a>
				    
				    </form>
				</div>
				
				<div th:each="generalForm : ${assignedForms}" class="card mb-3">
					<div class="card-header">
						<div class="d-flex justify-content-between align-items-center">
							<div>
								<strong th:text="${generalForm.name ?: 'N/A'}"></strong>
								<span th:text="${generalForm.surname ?: 'N/A'}"></span> |
								<span th:text="${generalForm.email ?: 'N/A'}"></span>
							</div>

							<!-- Arrow to expand/collapse -->
							<button class="btn btn-link" type="button" data-toggle="collapse"
								th:data-target="'#details-' + ${generalForm.id}">
								➤
							</button>
						</div>
					</div>

					<!-- Collapsible content for InformationForms -->
					<div th:id="'details-' + ${generalForm.id}" class="collapse">
						<div class="card-body">
							<div th:if="${generalForm.informationForms != null and generalForm.informationForms.size() > 0}">
								<table class="table">
									<thead>
										<tr>
											<th>Category</th>
											<th>Content</th>
											<th>Date</th>
											<th>Status</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
	
										<!-- Loop through InformationForms -->
										<tr th:each="informationForm : ${generalForm.informationForms}">
											<td th:text="${generalForm.category.name ?: 'No category'}"></td>
											<!-- Display Category -->
											<td th:text="${informationForm.getContent() ?: 'No content'}"></td>
											<td th:text="${generalForm.submissionDate.format(formatter) ?: 'No date'}"></td>
											<td th:text="${informationForm.getStatus() ?: 'TO DO'}">
											<td>
	
												<!-- Button to open the assignment modal for status-->
												<button class="btn btn-primary btn-sm" type="button" data-toggle="modal"
													th:data-target="'#assignStatusModal-' + ${informationForm.id}">
													Assign Status
												</button>
	
												<!-- Modal for status assignment -->
												<div th:id="'assignStatusModal-' + ${informationForm.id}" class="modal fade"
													tabindex="-1" role="dialog" aria-labelledby="assignStatusModalLabel"
													aria-hidden="true">
													<div class="modal-dialog" role="document">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title">Assign Status</h5>
																<button type="button" class="close" data-dismiss="modal"
																	aria-label="Close">
																	<span aria-hidden="true">&times;</span>
																</button>
															</div>
															<div class="modal-body">
																<form action="/admin/assignStatusPublicProfile"
																	method="post">
																	<input type="hidden" th:name="informationFormId"
																		th:value="${informationForm.id}">
																	<input type="hidden" th:name="userId"
																		th:value="${user.id}">
	
																	<!-- Status dropdown list -->
																	<div class="form-group">
																		<label for="statusSelect">Select a status</label>
																		<select class="form-control" id="statusSelect"
																			name="informationFormStatus" required>
																			<option value="" disabled selected>Select a
																				status</option>
																			<option value="TO DO">To do</option>
																			<option value="IN PROGRESS">In progress</option>
																			<option value="DONE">Done</option>
																		</select>
																	</div>
																	<button type="submit"
																		class="btn btn-success">Assign</button>
																</form>
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div th:if="${generalForm.bookingForms != null and generalForm.bookingForms.size() > 0}">
									<!-- Table for Booking Forms -->
					                <table class="table mt-4">
					                    <thead>
					                        <tr>
					                        	<th>Category</th>
					                            <th>Content</th>
					                            <th>Date</th>
					                            <th>Check-In</th>
					                            <th>Check-Out</th>
					                            <th>Status</th>
					                            <th>Assigned User</th>
					                            <th sec:authorize="hasRole('ADMIN')">Action</th>
					                        </tr>
					                    </thead>
					                    <tbody>
					                        <!-- Loop through BookingForms associated with the current GeneralForm -->
					                        <tr th:each="bookingForm : ${generalForm.bookingForms}">
					                        	<td th:text="${generalForm.category.name ?: 'No category'}"></td>
					                            <td th:text="${bookingForm.content ?: 'No content'}"></td>
					                            <td th:text="${generalForm.submissionDate.format(formatter) ?: 'No date'}"></td>
					                            <td th:text="${#dates.format(bookingForm.checkIn, 'dd-MM-yyyy') ?: 'No check-in date'}"></td>
					                            <td th:text="${#dates.format(bookingForm.checkOut, 'dd-MM-yyyy') ?: 'No check-out date'}"></td>
					                            <td th:text="${bookingForm.status ?: 'No status'}"></td>
					                            <td>
					                                <div class="d-flex align-items-center">
					                                    <div th:if="${bookingForm.getAssignedUser() != null}">
					                                        <img th:src="${bookingForm.getAssignedUser().getUserImage() != null ? bookingForm.getAssignedUser().getUserImage().imgPath : '/default-user-image.png'}"
					                                            class="profile-image" th:alt="'Image of ' + ${bookingForm.getAssignedUser().name + ' ' + bookingForm.getAssignedUser().surname}"
					                                            data-toggle="tooltip" th:title="${bookingForm.getAssignedUser().name + ' ' + bookingForm.getAssignedUser().surname}" />
					                                    </div>
					                                    <div th:if="${bookingForm.getAssignedUser() == null}">
					                                        <span>No employee assigned</span>
					                                    </div>
					                                </div>
					                            </td>
					                            <td>
	
													<!-- Button to open the assignment modal for user-->
													<button sec:authorize="hasRole('ADMIN')" class="btn btn-primary btn-sm"
														type="button" data-toggle="modal"
														th:data-target="'#assignUserModal-' + ${bookingForm.id}">
														Assign User
													</button>
	
													<!-- Form to remove the currently assigned user from the InformationForm -->
													<form th:action="@{/removeUserFromBookingForm}" method="post"
														th:if="${bookingForm.getAssignedUser() != null}"
														sec:authorize="hasRole('ADMIN')"
														onsubmit="return confirm('Are you sure you want to remove this user from the booking form?');">
														<input type="hidden" name="bookingFormId"
															th:value="${bookingForm.id}" />
														<input type="hidden" name="userId"
															th:value="${bookingForm.getAssignedUser().id}" />
														<button type="submit" class="btn btn-danger btn-sm">Remove
															User</button>
													</form>
	
													<!-- Button to open the assignment modal for status-->
													<button sec:authorize="hasRole('ADMIN')" class="btn btn-primary btn-sm"
														type="button" data-toggle="modal"
														th:data-target="'#assignStatusModal-' + ${bookingForm.id}">
														Assign Status
													</button>
	
													<!-- Modal for user assignment -->
													<div th:id="'assignUserModal-' + ${bookingForm.id}"
														class="modal fade" tabindex="-1" role="dialog"
														aria-labelledby="assignUserModalLabel" aria-hidden="true">
														<div class="modal-dialog" role="document">
															<div class="modal-content">
																<div class="modal-header">
																	<h5 class="modal-title">Assign User</h5>
																	<button type="button" class="close" data-dismiss="modal"
																		aria-label="Close">
																		<span aria-hidden="true">&times;</span>
																	</button>
																</div>
																<div class="modal-body">
																	<form action="/assignUserBooking" method="post">
																		<input type="hidden" th:name="bookingFormId"
																			th:value="${bookingForm.id}">
	
																		<!-- User dropdown list -->
																		<div class="form-group">
																			<label for="userSelect">Select a User</label>
																			<select class="form-control" id="userSelect"
																				name="userId" required>
																				<option value="" disabled selected>Select a
																					user</option>
																				<option th:each="user : ${users}"
																					th:value="${user.id}"
																					th:text="${user.name + ' ' + user.surname}">
																				</option>
																			</select>
																		</div>
																		<button type="submit"
																			class="btn btn-success">Assign</button>
																	</form>
																</div>
															</div>
														</div>
													</div>
	
													<!-- Modal for status assignment -->
													<div th:id="'assignStatusModal-' + ${bookingForm.id}"
														class="modal fade" tabindex="-1" role="dialog"
														aria-labelledby="assignStatusModalLabel" aria-hidden="true">
														<div class="modal-dialog" role="document">
															<div class="modal-content">
																<div class="modal-header">
																	<h5 class="modal-title">Assign Status</h5>
																	<button type="button" class="close" data-dismiss="modal"
																		aria-label="Close">
																		<span aria-hidden="true">&times;</span>
																	</button>
																</div>
																<div class="modal-body">
																	<form action="/assignStatusBooking" method="post">
																		<input type="hidden" th:name="bookingFormId"
																			th:value="${bookingForm.id}">
	
																		<!-- Status dropdown list -->
																		<div class="form-group">
																			<label for="statusSelect">Select a
																				status</label>
																			<select class="form-control" id="statusSelect"
																				name="bookingFormStatus" required>
																				<option value="" disabled selected>Select a
																					status</option>
																				<option value="TO DO">To do</option>
																				<option value="IN PROGRESS">In progress
																				</option>
																				<option value="DONE">Done</option>
																			</select>
																		</div>
																		<button type="submit"
																			class="btn btn-success">Assign</button>
																	</form>
																</div>
															</div>
														</div>
													</div>
												</td>
					                        </tr>
					                    </tbody>
					                </table>
					            </div>
						</div>
					</div>
				</div>
			</div>

			<!-- Check if there's a message -->
			<div th:if="${noResults != null}">
				<p th:text="${noResults}"></p>
			</div>
			<div th:if="${assignedForms != null and assignedForms.size() > 0}">
				<!-- Pagination Controls -->
				<div class="pagination">
					<!-- First Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage > 1}"
						th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id}, page=1, sortBy=${sortBy}, categories=${#strings.arrayJoin(categoriesSelected, ',')}, statuses=${#strings.arrayJoin(statusesSelected, ',')}, formType=${formType})}">First</a>

					<!-- Previous Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage > 1}"
						th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id}, page=${currentPage - 1}, sortBy=${sortBy}, categories=${#strings.arrayJoin(categoriesSelected, ',')}, statuses=${#strings.arrayJoin(statusesSelected, ',')}, formType=${formType})}">Previous</a>

					<!-- Page Numbers -->
					<span th:each="i : ${#numbers.sequence(1, totalPages)}">
						<a class="btn btn-sm"
							th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id}, page=${i}, sortBy=${sortBy}, categories=${#strings.arrayJoin(categoriesSelected, ',')}, statuses=${#strings.arrayJoin(statusesSelected, ',')}, formType=${formType})}"
							th:classappend="${i == currentPage ? 'btn-primary text-white' : 'btn-light'}"
							th:text="${i}"></a>
					</span>

					<!-- Next Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage < totalPages}"
						th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id}, page=${currentPage + 1}, sortBy=${sortBy}, categories=${#strings.arrayJoin(categoriesSelected, ',')}, statuses=${#strings.arrayJoin(statusesSelected, ',')}, formType=${formType})}">Next</a>

					<!-- Last Page -->
					<a class="btn btn-sm btn-secondary" th:if="${currentPage < totalPages}"
						th:href="@{/admin/yourTasksPublic/{userId}(userId=${user.id}, page=${totalPages}, sortBy=${sortBy}, categories=${#strings.arrayJoin(categoriesSelected, ',')}, statuses=${#strings.arrayJoin(statusesSelected, ',')}, formType=${formType})}">Last</a>
				</div>
			</div>

		</div>
	</div>

	<!-- Script to toggle arrow direction -->
	<script>
		$(document).ready(function () {
			$(".arrow").click(function () {
				$(this).text($(this).text() === '➤' ? '▼' : '➤');
			});
		});
		$(document).ready(function () {
			$('[data-toggle="tooltip"]').tooltip();
		});
	</script>
</body>

</html>